# rules/patterns.yaml — Tier 1 pattern rules for ego-lint
#
# Format:
#   - id: R-XXXX-NN           # Unique rule ID
#     pattern: "regex"         # Python re syntax
#     scope: ["*.js"]          # Glob patterns relative to extension dir
#     severity: blocking       # blocking | advisory
#     message: "explanation"   # Human-readable message
#     category: category-name  # For grouping
#     fix: "how to fix"        # Optional
#     min-version: 46         # Optional: only check if extension targets this GNOME version or newer
#     max-version: 45         # Optional: only check if extension targets this version or older
#
# Add new rules by appending to this file. See CONTRIBUTING.md for details.

# --- Web APIs (blocking) ---
# These browser APIs are not available in GJS.

- id: R-WEB-01
  pattern: "\\bsetTimeout\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "setTimeout is a browser API; use GLib.timeout_add() or GLib.timeout_add_seconds()"
  category: web-apis
  fix: "GLib.timeout_add_seconds(GLib.PRIORITY_DEFAULT, seconds, callback)"

- id: R-WEB-02
  pattern: "\\bsetInterval\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "setInterval is a browser API; use GLib.timeout_add() with GLib.SOURCE_CONTINUE"
  category: web-apis
  fix: "GLib.timeout_add_seconds(GLib.PRIORITY_DEFAULT, seconds, () => { ...; return GLib.SOURCE_CONTINUE; })"

- id: R-WEB-03
  pattern: "\\bfetch\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "fetch is a browser API; use Soup.Session for HTTP requests"
  category: web-apis
  fix: "Import Soup from 'gi://Soup?version=3.0' and use Soup.Session"

- id: R-WEB-04
  pattern: "\\bXMLHttpRequest\\b"
  scope: ["*.js"]
  severity: blocking
  message: "XMLHttpRequest is a browser API; use Soup.Session"
  category: web-apis
  fix: "Import Soup from 'gi://Soup?version=3.0' and use Soup.Session."

- id: R-WEB-05
  pattern: "\\brequestAnimationFrame\\b"
  scope: ["*.js"]
  severity: blocking
  message: "requestAnimationFrame is a browser API; use Clutter animation framework"
  category: web-apis
  fix: "Use Clutter.Timeline or actor.ease() for animations."

- id: R-WEB-06
  pattern: "\\bdocument\\."
  scope: ["*.js"]
  severity: blocking
  message: "DOM APIs (document.*) are not available in GJS"
  category: web-apis
  fix: "GJS has no DOM. Use GObject/Clutter/St/GTK widgets instead."

- id: R-WEB-07
  pattern: "\\bwindow\\.(document|location|navigator|localStorage|sessionStorage|alert|confirm|prompt|history|performance)"
  scope: ["*.js"]
  severity: blocking
  message: "Browser window properties are not available in GJS (window is a GTK widget in prefs.js)"
  category: web-apis
  fix: "In prefs.js, use the GTK widget directly. In extension.js, there is no window object."

- id: R-WEB-08
  pattern: "\\blocalStorage\\b"
  scope: ["*.js"]
  severity: blocking
  message: "localStorage is a browser API; use GSettings for persistent storage"
  category: web-apis
  fix: "Use GSettings (this.getSettings()) for persistent key-value storage."

- id: R-WEB-09
  pattern: "\\brequire\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "require() is Node.js; use ESM imports (import ... from ...)"
  category: web-apis
  fix: "Use ESM: import X from 'gi://X' or import {Y} from 'resource:///path/to/module.js'."

# --- Deprecated APIs (blocking) ---

- id: R-DEPR-05
  pattern: "\\bExtensionUtils\\b"
  scope: ["*.js"]
  severity: blocking
  message: "ExtensionUtils removed in GNOME 45+; use Extension/ExtensionPreferences class methods"
  category: deprecated
  fix: "Use this.getSettings(), this.gettext(), this.path, etc. from the Extension base class"

- id: R-DEPR-06
  pattern: "\\bTweener\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Tweener is removed; use Clutter animation framework"
  category: deprecated
  fix: "Use actor.ease({property: value, duration: ms, mode: Clutter.AnimationMode.EASE_OUT_QUAD})."

- id: R-DEPR-07
  pattern: "imports\\.misc\\.convenience"
  scope: ["*.js"]
  severity: blocking
  message: "Convenience module removed in GNOME 45+; use Extension class methods"
  category: deprecated
  fix: "Use this.getSettings() from the Extension base class."

# --- AI slop signals (advisory) ---
# These patterns are not wrong per se, but signal unreviewed AI-generated code.

- id: R-SLOP-01
  pattern: "@param\\s*\\{\\w+\\}"
  scope: ["*.js"]
  severity: advisory
  message: "TypeScript-style JSDoc (@param {Type}) is unusual in GNOME extensions"
  category: ai-slop
  fix: "Remove @param {Type} annotations; GNOME extensions don't use TypeScript-style JSDoc."

- id: R-SLOP-02
  pattern: "@returns\\s*\\{\\w+\\}"
  scope: ["*.js"]
  severity: advisory
  message: "TypeScript-style JSDoc (@returns {Type}) is unusual in GNOME extensions"
  category: ai-slop
  fix: "Remove @returns {Type} annotations; GNOME extensions don't use TypeScript-style JSDoc."

- id: R-SLOP-03
  pattern: "\"version\":\\s*\\d"
  scope: ["metadata.json"]
  severity: advisory
  message: "version field is deprecated; EGO manages versions for GNOME 45+"
  category: ai-slop
  fix: "Remove the version field from metadata.json; EGO manages versions automatically."

- id: R-SLOP-04
  pattern: "\"version-name\""
  scope: ["metadata.json"]
  severity: advisory
  message: "version-name is a non-standard metadata field"
  category: ai-slop
  fix: "Remove the version-name field; it is not a standard EGO metadata field."

- id: R-SLOP-05
  pattern: "\"homepage\""
  scope: ["metadata.json"]
  severity: advisory
  message: "homepage is a non-standard metadata field; use url instead"
  category: ai-slop
  fix: "Rename homepage to url in metadata.json."

- id: R-SLOP-06
  pattern: "\"bug-report-url\""
  scope: ["metadata.json"]
  severity: advisory
  message: "bug-report-url is a non-standard metadata field"
  category: ai-slop
  fix: "Remove bug-report-url; use the url field for your project URL."

# --- Security (blocking) ---
# These patterns indicate security risks that will cause EGO rejection.

- id: R-SEC-01
  pattern: "\\beval\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "eval() is a security risk; never execute dynamic code"
  category: security
  fix: "Remove eval() entirely. If parsing JSON, use JSON.parse(). If computing values, use a lookup table."

- id: R-SEC-02
  pattern: "\\bnew\\s+Function\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "new Function() is equivalent to eval(); avoid dynamic code execution"
  category: security
  fix: "Replace with a direct function definition or a lookup table."

- id: R-SEC-03
  pattern: "http://(?!localhost|127\\.0\\.0\\.1|\\[::1\\])"
  scope: ["*.js"]
  severity: advisory
  message: "Use HTTPS instead of HTTP for network requests"
  category: security
  fix: "Change http:// to https://."

- id: R-SEC-04
  pattern: "\\bpkexec\\b|\\bsudo\\b"
  scope: ["*.js", "*.sh"]
  severity: blocking
  message: "pkexec/sudo requires explicit EGO reviewer justification; prefer udev rules for hardware access"
  category: security
  fix: "Use a udev rule to grant write access to sysfs files, or a systemd service with capabilities."

- id: R-SEC-05
  pattern: "Subprocess.*'/bin/sh'.*'-c'"
  scope: ["*.js"]
  severity: advisory
  message: "Subprocess with /bin/sh -c risks command injection; use explicit argv array"
  category: security
  fix: "Pass command and arguments as separate argv array elements instead of a shell string."

# --- Browser APIs (blocking, continued) ---

- id: R-WEB-10
  pattern: "\\bclearTimeout\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "clearTimeout is a browser API; use GLib.Source.remove(sourceId)"
  category: web-apis
  fix: "Store the return value of GLib.timeout_add() and pass it to GLib.Source.remove()."

- id: R-WEB-11
  pattern: "\\bclearInterval\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "clearInterval is a browser API; use GLib.Source.remove(sourceId)"
  category: web-apis
  fix: "Store the return value of GLib.timeout_add() and pass it to GLib.Source.remove()."

# --- Logging (advisory) ---

- id: R-LOG-02
  pattern: "(?<![.\\w])log\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "Legacy log() function; use console.debug() instead"
  category: logging
  fix: "Replace log(...) with console.debug(...)."

- id: R-LOG-03
  pattern: "\\b(print|printerr)\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "print()/printerr() should not be used in production; use console.debug()"
  category: logging
  fix: "Replace print()/printerr() with console.debug() or console.error()."

# --- Deprecated APIs (continued) ---

- id: R-DEPR-04
  pattern: "\\bimports\\.(ui|gi|misc)\\."
  scope: ["*.js"]
  severity: advisory
  message: "Legacy imports.* syntax; use ESM imports for GNOME 45+"
  category: deprecated
  fix: "Replace 'const X = imports.ui.main' with 'import * as Main from \"resource:///org/gnome/shell/ui/main.js\"'."

- id: R-DEPR-08
  pattern: "\\bspawn_command_line_sync\\b"
  scope: ["*.js"]
  severity: advisory
  message: "GLib.spawn_command_line_sync is deprecated; use Gio.Subprocess"
  category: deprecated
  fix: "Use new Gio.Subprocess({argv: [...], flags: ...}) instead."

# --- Import segregation (blocking) ---

- id: R-IMPORT-08
  pattern: "resource:///org/gnome/shell/ui/"
  scope: ["prefs.js"]
  severity: blocking
  message: "GNOME Shell UI modules are not available in the preferences process"
  category: imports
  fix: "Preferences must only use GTK/Adw/Gio/GLib. Shell UI modules run in a different process."

# --- AI slop signals (advisory, continued) ---

- id: R-SLOP-07
  pattern: "\\.get_button\\(\\)\\s*===?\\s*[123]"
  scope: ["*.js"]
  severity: advisory
  message: "Use Clutter.BUTTON_PRIMARY/SECONDARY/MIDDLE instead of magic numbers"
  category: ai-slop
  fix: "Replace 1 with Clutter.BUTTON_PRIMARY, 2 with Clutter.BUTTON_MIDDLE, 3 with Clutter.BUTTON_SECONDARY."

# --- Hallucinated APIs (advisory) ---
# LLMs frequently call methods that don't exist in GJS/GNOME Shell.

- id: R-SLOP-08
  pattern: "\\b(Meta\\.Screen|Meta\\.Cursor|Shell\\.ActionMode\\.ALL|Shell\\.WindowTracker\\.get_default\\(\\)\\.get_active_window)"
  scope: ["*.js"]
  severity: advisory
  message: "Likely hallucinated API — Meta.Screen, Meta.Cursor, Shell.ActionMode.ALL do not exist"
  category: ai-slop
  fix: "Check the GJS API docs: https://gjs-docs.gnome.org. Use Meta.Display, global.display, etc."

- id: R-SLOP-09
  pattern: "\\bSt\\.(Button|Label|Widget)\\.(set_label|set_text|set_icon_name)\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "St widgets use GObject properties, not setter methods (set_label, set_text)"
  category: ai-slop
  fix: "Use property assignment: this.label = 'text' instead of this.set_label('text')."

- id: R-SLOP-10
  pattern: "\\bClutter\\.Actor\\.(show_all|hide_all|set_position|set_size)\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "Hallucinated Clutter method — show_all/hide_all/set_position/set_size are GTK, not Clutter"
  category: ai-slop
  fix: "Use actor.show()/hide() for visibility. Use actor.set({x, y, width, height}) for geometry."

- id: R-SLOP-11
  pattern: "\\bGLib\\.(timeout_add_seconds_full|source_remove)\\b"
  scope: ["*.js"]
  severity: advisory
  message: "Non-existent GLib method — use GLib.timeout_add_seconds() and GLib.Source.remove()"
  category: ai-slop
  fix: "GLib.timeout_add_seconds_full → GLib.timeout_add_seconds. GLib.source_remove → GLib.Source.remove."

# --- Security (continued) ---

- id: R-SEC-06
  pattern: "\\.run_dispose\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "GObject.run_dispose() should not be used unless absolutely necessary"
  category: security
  fix: "Remove run_dispose() call. If genuinely needed, add a comment explaining why."

# --- AI slop (continued) ---

- id: R-SLOP-12
  pattern: "typeof\\s+super\\.destroy\\s*===?\\s*['\"]function['\"]"
  scope: ["*.js"]
  severity: advisory
  message: "typeof super.destroy check is unnecessary — super.destroy() always exists on GObject classes"
  category: ai-slop
  fix: "Remove the typeof check and call super.destroy() directly."

- id: R-SLOP-13
  pattern: "\\bthis\\s+instanceof\\s+\\w+"
  scope: ["*.js"]
  severity: advisory
  message: "this instanceof check inside a class method is always true"
  category: ai-slop
  fix: "Remove the redundant instanceof check."

# --- Security (continued) ---

- id: R-SEC-07
  pattern: "\\bSt\\.Clipboard\\b"
  scope: ["*.js"]
  severity: advisory
  message: "Clipboard access must be disclosed in metadata.json description"
  category: security
  fix: "Add clipboard usage disclosure to your extension description on EGO."

- id: R-SEC-08
  pattern: "\\b(analytics|telemetry|trackEvent|trackPage|GA_TRACKING_ID|gtag)\\b"
  scope: ["*.js"]
  severity: advisory
  message: "Telemetry/analytics is banned in GNOME extensions"
  category: security
  fix: "Remove all telemetry/analytics code. EGO explicitly bans user tracking."

- id: R-SEC-09
  pattern: "\\b(Main\\.extensionManager|ExtensionManager|lookupByUUID)\\b"
  scope: ["*.js"]
  severity: advisory
  message: "Extension system interference is discouraged; modifying other extensions requires justification"
  category: security
  fix: "Avoid interacting with other extensions unless absolutely necessary. Document the justification."

# --- Deprecated (continued) ---

- id: R-DEPR-09
  pattern: "^\\s*var\\s+\\w"
  scope: ["*.js"]
  severity: advisory
  message: "Use const/let instead of var; var has function scope and causes bugs in closures"
  category: deprecated
  fix: "Replace var with const (preferred) or let (when reassignment needed)."

- id: R-DEPR-10
  pattern: "\\bimports\\.format\\b"
  scope: ["*.js"]
  severity: blocking
  message: "imports.format is deprecated; use ES6 template literals"
  category: deprecated
  fix: "Replace format() calls with template literals: `my ${variable} string`."

# --- Hallucinated APIs (continued) ---

- id: R-SLOP-16
  pattern: "\\bGLib\\.file_get_contents\\b"
  scope: ["*.js"]
  severity: blocking
  message: "GLib.file_get_contents() does not exist in GJS; use Gio.File.load_contents()"
  category: ai-slop
  fix: "Use: const [ok, contents] = file.load_contents(null); then TextDecoder to decode."

# --- Web APIs (continued) ---

- id: R-WEB-12
  pattern: "\\bPromise\\.race\\s*\\("
  scope: ["*.js"]
  severity: advisory
  message: "Promise.race() is risky without _destroyed guards; verify async safety"
  category: web-apis
  fix: "Ensure _destroyed is checked after the race resolves. Consider simpler alternatives."

# --- Package installation bans (blocking) ---
# Extensions MUST NOT automatically install packages.

- id: R-SEC-10
  pattern: "\\bpip\\s+install\\b"
  scope: ["*.js", "*.sh"]
  severity: blocking
  message: "Automatic pip install is banned; extensions must not install packages without explicit user action"
  category: security
  fix: "Remove automatic pip install. If a Python dependency is needed, document manual installation steps."

- id: R-SEC-11
  pattern: "\\bnpm\\s+install\\b"
  scope: ["*.js", "*.sh"]
  severity: blocking
  message: "Automatic npm install is banned; extensions must not install packages without explicit user action"
  category: security
  fix: "Remove automatic npm install. If a Node dependency is needed, document manual installation steps."

- id: R-SEC-12
  pattern: "\\b(apt|apt-get|dnf|yum|pacman|zypper)\\s+(install|-S)\\b"
  scope: ["*.js", "*.sh"]
  severity: blocking
  message: "Automatic system package installation is banned; extensions must not install packages without explicit user action"
  category: security
  fix: "Remove automatic package installation. Document manual installation steps for required system packages."

# --- GNOME 46 removed APIs (blocking, version-gated) ---

- id: R-VER46-01
  pattern: "\\.add_actor\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "Clutter.Container.add_actor() removed in GNOME 46; use add_child()"
  category: version-compat
  fix: "Replace .add_actor(child) with .add_child(child)"
  min-version: 46

- id: R-VER46-02
  pattern: "\\.remove_actor\\s*\\("
  scope: ["*.js"]
  severity: blocking
  message: "Clutter.Container.remove_actor() removed in GNOME 46; use remove_child()"
  category: version-compat
  fix: "Replace .remove_actor(child) with .remove_child(child)"
  min-version: 46

- id: R-VER46-03
  pattern: "\\bClutter\\.cairo_set_source_color\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Clutter.cairo_set_source_color() removed in GNOME 46; use cairo.Context.setSourceColor()"
  category: version-compat
  fix: "Use cr.setSourceColor(color) instead"
  min-version: 46

- id: R-VER46-04
  pattern: "\\bGio\\.UnixInputStream\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Gio.UnixInputStream moved to GioUnix.InputStream in GNOME 46"
  category: version-compat
  fix: "Import GioUnix from 'gi://GioUnix' and use GioUnix.InputStream"
  min-version: 46

- id: R-VER46-05
  pattern: "\\bExtensionState\\.(ENABLED|DISABLED|INITIALIZED|DEACTIVATING|ACTIVATING)\\b"
  scope: ["*.js"]
  severity: blocking
  message: "ExtensionState enum renamed in GNOME 46: ENABLED->ACTIVE, DISABLED->INACTIVE, etc."
  category: version-compat
  fix: "Use ACTIVE, INACTIVE, ENABLING, DISABLING instead"
  min-version: 46

# --- GNOME 47 removed APIs (blocking, version-gated) ---

- id: R-VER47-01
  pattern: "\\bClutter\\.Color\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Clutter.Color removed in GNOME 47; use Cogl.Color()"
  category: version-compat
  fix: "Import Cogl from 'gi://Cogl' and use new Cogl.Color() instead"
  min-version: 47

# --- GNOME 48 removed APIs (blocking, version-gated) ---

- id: R-VER48-01
  pattern: "\\bClutter\\.Image\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Clutter.Image removed in GNOME 48; use St.ImageContent"
  category: version-compat
  fix: "Use St.ImageContent instead of Clutter.Image"
  min-version: 48

- id: R-VER48-02
  pattern: "\\bMeta\\.(disable_unredirect_for_display|enable_unredirect_for_display|get_window_actors|get_window_group_for_display|get_top_window_group_for_display)\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Meta display functions moved to Meta.Compositor in GNOME 48; use global.compositor"
  category: version-compat
  fix: "Access via global.compositor instead of Meta directly"
  min-version: 48

- id: R-VER48-03
  pattern: "\\bCursorTracker\\.get_for_display\\b"
  scope: ["*.js"]
  severity: blocking
  message: "Meta.CursorTracker.get_for_display() changed in GNOME 48; use global.backend.get_cursor_tracker()"
  category: version-compat
  fix: "Use global.backend.get_cursor_tracker() instead"
  min-version: 48
